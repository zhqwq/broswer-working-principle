<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.43">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>10 | 作用域链和闭包 ：代码中出现相同的变量，JavaScript引擎是如何选择的？ | 浏览器工作原理与实践</title><meta name="description" content="浏览器工作原理与实践 - 李兵">
    <link rel="modulepreload" href="/broswer-working-principle/assets/app.7d025128.js"><link rel="modulepreload" href="/broswer-working-principle/assets/10.html.23bc7225.js"><link rel="modulepreload" href="/broswer-working-principle/assets/10.html.cdbb583c.js"><link rel="prefetch" href="/broswer-working-principle/assets/index.html.82a93635.js"><link rel="prefetch" href="/broswer-working-principle/assets/01.html.c8da2b6e.js"><link rel="prefetch" href="/broswer-working-principle/assets/02.html.b244f45e.js"><link rel="prefetch" href="/broswer-working-principle/assets/03.html.7e296279.js"><link rel="prefetch" href="/broswer-working-principle/assets/04.html.44afb11e.js"><link rel="prefetch" href="/broswer-working-principle/assets/05.html.1f43d153.js"><link rel="prefetch" href="/broswer-working-principle/assets/06.html.6a2487c3.js"><link rel="prefetch" href="/broswer-working-principle/assets/07.html.647743fb.js"><link rel="prefetch" href="/broswer-working-principle/assets/08.html.57921165.js"><link rel="prefetch" href="/broswer-working-principle/assets/09.html.dda209e4.js"><link rel="prefetch" href="/broswer-working-principle/assets/11.html.cf85adc2.js"><link rel="prefetch" href="/broswer-working-principle/assets/12.html.2521bbd1.js"><link rel="prefetch" href="/broswer-working-principle/assets/13.html.5c6deb69.js"><link rel="prefetch" href="/broswer-working-principle/assets/14.html.381267b1.js"><link rel="prefetch" href="/broswer-working-principle/assets/15.html.d3bd7be0.js"><link rel="prefetch" href="/broswer-working-principle/assets/16.html.d4f45e08.js"><link rel="prefetch" href="/broswer-working-principle/assets/17.html.57b8bd68.js"><link rel="prefetch" href="/broswer-working-principle/assets/18.html.1217ca1a.js"><link rel="prefetch" href="/broswer-working-principle/assets/19.html.645019c0.js"><link rel="prefetch" href="/broswer-working-principle/assets/20.html.e03efe45.js"><link rel="prefetch" href="/broswer-working-principle/assets/21.html.dcf257c9.js"><link rel="prefetch" href="/broswer-working-principle/assets/22.html.a3207225.js"><link rel="prefetch" href="/broswer-working-principle/assets/23.html.8121c388.js"><link rel="prefetch" href="/broswer-working-principle/assets/24.html.ab97fcb7.js"><link rel="prefetch" href="/broswer-working-principle/assets/25.html.21ccb19a.js"><link rel="prefetch" href="/broswer-working-principle/assets/26.html.2820a164.js"><link rel="prefetch" href="/broswer-working-principle/assets/27.html.d258fbff.js"><link rel="prefetch" href="/broswer-working-principle/assets/28.html.0783965d.js"><link rel="prefetch" href="/broswer-working-principle/assets/29.html.a3b531ba.js"><link rel="prefetch" href="/broswer-working-principle/assets/30.html.b8d39ad6.js"><link rel="prefetch" href="/broswer-working-principle/assets/31.html.a60f2960.js"><link rel="prefetch" href="/broswer-working-principle/assets/32.html.8f867d89.js"><link rel="prefetch" href="/broswer-working-principle/assets/33.html.f4fa6306.js"><link rel="prefetch" href="/broswer-working-principle/assets/34.html.8253388f.js"><link rel="prefetch" href="/broswer-working-principle/assets/35.html.287f2d25.js"><link rel="prefetch" href="/broswer-working-principle/assets/36.html.ede0a3e5.js"><link rel="prefetch" href="/broswer-working-principle/assets/end.html.ea97750b.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-1.html.a71eceff.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-2.html.b5c1ee50.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-3.html.024134a8.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-4.html.c8992c4b.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-5.html.8581eac6.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-6.html.d972a33a.js"><link rel="prefetch" href="/broswer-working-principle/assets/intro.html.45f3f741.js"><link rel="prefetch" href="/broswer-working-principle/assets/404.html.93146c89.js"><link rel="prefetch" href="/broswer-working-principle/assets/index.html.997b679f.js"><link rel="prefetch" href="/broswer-working-principle/assets/01.html.c7ced5d9.js"><link rel="prefetch" href="/broswer-working-principle/assets/02.html.7de524fe.js"><link rel="prefetch" href="/broswer-working-principle/assets/03.html.084ad8b6.js"><link rel="prefetch" href="/broswer-working-principle/assets/04.html.b2354030.js"><link rel="prefetch" href="/broswer-working-principle/assets/05.html.768eef31.js"><link rel="prefetch" href="/broswer-working-principle/assets/06.html.01294057.js"><link rel="prefetch" href="/broswer-working-principle/assets/07.html.394294f1.js"><link rel="prefetch" href="/broswer-working-principle/assets/08.html.35818143.js"><link rel="prefetch" href="/broswer-working-principle/assets/09.html.6ca2b3ec.js"><link rel="prefetch" href="/broswer-working-principle/assets/11.html.6ac48bbc.js"><link rel="prefetch" href="/broswer-working-principle/assets/12.html.f31dac47.js"><link rel="prefetch" href="/broswer-working-principle/assets/13.html.350478c6.js"><link rel="prefetch" href="/broswer-working-principle/assets/14.html.e9d1ded5.js"><link rel="prefetch" href="/broswer-working-principle/assets/15.html.2ad3b8f6.js"><link rel="prefetch" href="/broswer-working-principle/assets/16.html.a635e4ef.js"><link rel="prefetch" href="/broswer-working-principle/assets/17.html.f0e288cf.js"><link rel="prefetch" href="/broswer-working-principle/assets/18.html.7bc35d97.js"><link rel="prefetch" href="/broswer-working-principle/assets/19.html.7e1046f7.js"><link rel="prefetch" href="/broswer-working-principle/assets/20.html.9a6908cc.js"><link rel="prefetch" href="/broswer-working-principle/assets/21.html.94648f8d.js"><link rel="prefetch" href="/broswer-working-principle/assets/22.html.36565699.js"><link rel="prefetch" href="/broswer-working-principle/assets/23.html.6bee3b29.js"><link rel="prefetch" href="/broswer-working-principle/assets/24.html.b9b53c8e.js"><link rel="prefetch" href="/broswer-working-principle/assets/25.html.08060580.js"><link rel="prefetch" href="/broswer-working-principle/assets/26.html.573c95e7.js"><link rel="prefetch" href="/broswer-working-principle/assets/27.html.85f9dbe2.js"><link rel="prefetch" href="/broswer-working-principle/assets/28.html.1cf9ad54.js"><link rel="prefetch" href="/broswer-working-principle/assets/29.html.5b86ec75.js"><link rel="prefetch" href="/broswer-working-principle/assets/30.html.66dedd16.js"><link rel="prefetch" href="/broswer-working-principle/assets/31.html.773e7089.js"><link rel="prefetch" href="/broswer-working-principle/assets/32.html.c8d576df.js"><link rel="prefetch" href="/broswer-working-principle/assets/33.html.1d6c51ac.js"><link rel="prefetch" href="/broswer-working-principle/assets/34.html.180e3126.js"><link rel="prefetch" href="/broswer-working-principle/assets/35.html.07872742.js"><link rel="prefetch" href="/broswer-working-principle/assets/36.html.a3b639b6.js"><link rel="prefetch" href="/broswer-working-principle/assets/end.html.f3ed0f1e.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-1.html.887f657f.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-2.html.11ddfc46.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-3.html.89b72768.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-4.html.e5aa1927.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-5.html.ac7ead75.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-6.html.f82266a6.js"><link rel="prefetch" href="/broswer-working-principle/assets/intro.html.8d1d1025.js"><link rel="prefetch" href="/broswer-working-principle/assets/404.html.bd43ddad.js"><link rel="prefetch" href="/broswer-working-principle/assets/404.d1126912.js"><link rel="prefetch" href="/broswer-working-principle/assets/Layout.7bd61645.js">
    <link rel="stylesheet" href="/broswer-working-principle/assets/style.8d3ba15e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/broswer-working-principle/" class=""><!----><span class="site-name">浏览器工作原理与实践</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/broswer-working-principle/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/broswer-working-principle/guide/intro" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/broswer-working-principle/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/broswer-working-principle/guide/intro" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">开篇词 (1讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/intro" class="sidebar-item" aria-label="开篇词 | 参透了浏览器的工作原理, 你就能解决80%的前端难题"><!--[--><!--]--> 开篇词 | 参透了浏览器的工作原理, 你就能解决80%的前端难题 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">宏观视角下的浏览器 (6讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/01" class="sidebar-item" aria-label="01 | Chrome架构: 仅仅打开了1个页面, 为什么有4个进程"><!--[--><!--]--> 01 | Chrome架构: 仅仅打开了1个页面, 为什么有4个进程 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/02" class="sidebar-item" aria-label="02 | TCP协议: 如何保证页面文件能被完整送达浏览器?"><!--[--><!--]--> 02 | TCP协议: 如何保证页面文件能被完整送达浏览器? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/03" class="sidebar-item" aria-label="03 | HTTP请求流程: 为什么很多站点第二次打开速度会很快?"><!--[--><!--]--> 03 | HTTP请求流程: 为什么很多站点第二次打开速度会很快? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/04" class="sidebar-item" aria-label="04 | 导航流程: 从输入URL到页面展示, 这中间发生了什么?"><!--[--><!--]--> 04 | 导航流程: 从输入URL到页面展示, 这中间发生了什么? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/05" class="sidebar-item" aria-label="05 | 渲染流程(上): HTML、CSS和JavaScript, 是如何变成页面的?"><!--[--><!--]--> 05 | 渲染流程(上): HTML、CSS和JavaScript, 是如何变成页面的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/06" class="sidebar-item" aria-label="06 | 渲染流程(下): HTML、CSS和JavaScript, 是如何变成页面的?"><!--[--><!--]--> 06 | 渲染流程(下): HTML、CSS和JavaScript, 是如何变成页面的? <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">浏览器中的JavaScript执行机制 (5讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/07" class="sidebar-item" aria-label="07 | 变量提升: JavaScript代码是按顺序执行的吗?"><!--[--><!--]--> 07 | 变量提升: JavaScript代码是按顺序执行的吗? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/08" class="sidebar-item" aria-label="08 | 调用栈: 为什么JavaScript代码会出现栈溢出?"><!--[--><!--]--> 08 | 调用栈: 为什么JavaScript代码会出现栈溢出? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/09" class="sidebar-item" aria-label="09 | 块级作用域: var缺陷以及为什么要引入let和const?"><!--[--><!--]--> 09 | 块级作用域: var缺陷以及为什么要引入let和const? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/10" class="router-link-active sidebar-item active" aria-label="10 | 作用域链和闭包: 代码中出现相同的变量,JavaScript引擎是如何选择的?"><!--[--><!--]--> 10 | 作用域链和闭包: 代码中出现相同的变量,JavaScript引擎是如何选择的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/11" class="sidebar-item" aria-label="11 | this: 从JavaScript执行上下文的视角讲清楚this"><!--[--><!--]--> 11 | this: 从JavaScript执行上下文的视角讲清楚this <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">V8工作原理 (3讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/12" class="sidebar-item" aria-label="12 | 栈空间和堆空间：数据是如何存储的？"><!--[--><!--]--> 12 | 栈空间和堆空间：数据是如何存储的？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/13" class="sidebar-item" aria-label="13 | 垃圾回收：垃圾数据是如何自动回收的？"><!--[--><!--]--> 13 | 垃圾回收：垃圾数据是如何自动回收的？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/14" class="sidebar-item" aria-label="14 | 编译器和解释器: V8是如何执行一段JavaScript代码的?"><!--[--><!--]--> 14 | 编译器和解释器: V8是如何执行一段JavaScript代码的? <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器中的页面循环系统 (6讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/15" class="sidebar-item" aria-label="15 | 消息队列和事件循环：页面是怎么“活”起来的？"><!--[--><!--]--> 15 | 消息队列和事件循环：页面是怎么“活”起来的？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/16" class="sidebar-item" aria-label="16 | WebAPI: setTimeout是如何实现的?"><!--[--><!--]--> 16 | WebAPI: setTimeout是如何实现的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/17" class="sidebar-item" aria-label="17 | WebAPI: XMLHttpRequest是怎么实现的?"><!--[--><!--]--> 17 | WebAPI: XMLHttpRequest是怎么实现的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/18" class="sidebar-item" aria-label="18 | 宏任务和微任务：不是所有任务都是一个待遇"><!--[--><!--]--> 18 | 宏任务和微任务：不是所有任务都是一个待遇 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/18" class="sidebar-item" aria-label="18 | 宏任务和微任务：不是所有任务都是一个待遇"><!--[--><!--]--> 18 | 宏任务和微任务：不是所有任务都是一个待遇 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/19" class="sidebar-item" aria-label="19 | Promise: 使用Promise, 告别回调函数"><!--[--><!--]--> 19 | Promise: 使用Promise, 告别回调函数 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/20" class="sidebar-item" aria-label="20 | async/await: 使用同步的方式去写异步代码"><!--[--><!--]--> 20 | async/await: 使用同步的方式去写异步代码 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器中的页面 (8讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/21" class="sidebar-item" aria-label="21 | Chrome开发者工具: 利用网络面板做性能分析"><!--[--><!--]--> 21 | Chrome开发者工具: 利用网络面板做性能分析 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/22" class="sidebar-item" aria-label="22 | DOM树: JavaScript是如何影响DOM树构建的?"><!--[--><!--]--> 22 | DOM树: JavaScript是如何影响DOM树构建的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/23" class="sidebar-item" aria-label="23 | 渲染流水线: CSS如何影响首次加载时的白屏时间?"><!--[--><!--]--> 23 | 渲染流水线: CSS如何影响首次加载时的白屏时间? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/24" class="sidebar-item" aria-label="24 | 分层和合成机制: 为什么CSS动画比JavaScript高效?"><!--[--><!--]--> 24 | 分层和合成机制: 为什么CSS动画比JavaScript高效? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/25" class="sidebar-item" aria-label="25 | 页面性能：如何系统地优化页面？"><!--[--><!--]--> 25 | 页面性能：如何系统地优化页面？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/26" class="sidebar-item" aria-label="26 | 虚拟DOM: 虚拟DOM和实际的DOM有何不同?"><!--[--><!--]--> 26 | 虚拟DOM: 虚拟DOM和实际的DOM有何不同? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/27" class="sidebar-item" aria-label="27 | 渐进式网页应用(PWA): 它究竟解决了Web应用的哪些问题?"><!--[--><!--]--> 27 | 渐进式网页应用(PWA): 它究竟解决了Web应用的哪些问题? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/28" class="sidebar-item" aria-label="28 | WebComponent: 像搭积木一样构建Web应用"><!--[--><!--]--> 28 | WebComponent: 像搭积木一样构建Web应用 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器中的网络 (3讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/29" class="sidebar-item" aria-label="29 | HTTP/1: HTTP性能优化"><!--[--><!--]--> 29 | HTTP/1: HTTP性能优化 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/30" class="sidebar-item" aria-label="30 | HTTP/2: 如何提升网络速度？"><!--[--><!--]--> 30 | HTTP/2: 如何提升网络速度？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/31" class="sidebar-item" aria-label="31|HTTP/3:甩掉TCP、TLS 的包袱，构建高效网络"><!--[--><!--]--> 31|HTTP/3:甩掉TCP、TLS 的包袱，构建高效网络 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器安全 (5讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/32" class="sidebar-item" aria-label="32 | 同源策略: 为什么XMLHttpRequest不能跨域请求资源?"><!--[--><!--]--> 32 | 同源策略: 为什么XMLHttpRequest不能跨域请求资源? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/33" class="sidebar-item" aria-label="33 | 跨站脚本攻击(XSS): 为什么Cookie中有HttpOnly属性?"><!--[--><!--]--> 33 | 跨站脚本攻击(XSS): 为什么Cookie中有HttpOnly属性? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/34" class="sidebar-item" aria-label="34 | CSRF攻击: 陌生链接不要随便点"><!--[--><!--]--> 34 | CSRF攻击: 陌生链接不要随便点 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/35" class="sidebar-item" aria-label="35 | 安全沙箱：页面和系统之间的隔离墙"><!--[--><!--]--> 35 | 安全沙箱：页面和系统之间的隔离墙 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/36" class="sidebar-item" aria-label="36 | HTTPS: 让数据传输更安全"><!--[--><!--]--> 36 | HTTPS: 让数据传输更安全 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">结束语 (3讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/end" class="sidebar-item" aria-label="结束语 | 大道至简"><!--[--><!--]--> 结束语 | 大道至简 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">课外加餐 (6讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/extra-1" class="sidebar-item" aria-label="加餐一｜浏览上下文组：如何计算Chrome中渲染进程的个数？"><!--[--><!--]--> 加餐一｜浏览上下文组：如何计算Chrome中渲染进程的个数？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-2" class="sidebar-item" aria-label="加餐二｜任务调度：有了setTimeOut，为什么还要使用rAF？"><!--[--><!--]--> 加餐二｜任务调度：有了setTimeOut，为什么还要使用rAF？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-3" class="sidebar-item" aria-label="加餐三｜加载阶段性能：使用Audits来优化Web性能"><!--[--><!--]--> 加餐三｜加载阶段性能：使用Audits来优化Web性能 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-4" class="sidebar-item" aria-label="加餐四｜页面性能工具：如何使用Performance？"><!--[--><!--]--> 加餐四｜页面性能工具：如何使用Performance？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-5" class="sidebar-item" aria-label="加餐五 | 性能分析工具：如何分析Performance中的Main指标？"><!--[--><!--]--> 加餐五 | 性能分析工具：如何分析Performance中的Main指标？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-6" class="sidebar-item" aria-label="加餐六｜HTTPS：浏览器如何验证数字证书？"><!--[--><!--]--> 加餐六｜HTTPS：浏览器如何验证数字证书？ <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="_10-作用域链和闭包-代码中出现相同的变量-javascript引擎是如何选择的" tabindex="-1"><a class="header-anchor" href="#_10-作用域链和闭包-代码中出现相同的变量-javascript引擎是如何选择的" aria-hidden="true">#</a> 10 | 作用域链和闭包 ：代码中出现相同的变量，JavaScript引擎是如何选择的？</h1><p>在<a href="/guide/09" target="_blank" rel="noopener noreferrer">上一篇文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>中我们讲到了什么是作用域，以及 ES6 是如何通过变量环境和词法环境来同时支持变量提升和块级作用域，在最后我们也提到了如何通过词法环境和变量环境来查找变量，这其中就涉及到<strong>作用域链</strong>的概念。</p><p>理解作用域链是理解闭包的基础，而闭包在 JavaScript 中几乎无处不在，同时作用域和作用域链还是所有编程语言的基础。所以，如果你想学透一门语言，作用域和作用域链一定是绕不开的。</p><p>那今天我们就来聊聊<strong>什么是作用域链</strong>，并通过作用域链再来讲讲<strong>什么是闭包</strong>。</p><p>首先我们来看下面这段代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客邦&quot;</span>
  <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>你觉得这段代码中的 bar 函数和 foo 函数打印出来的内容是什么？这就要分析下这两段代码的执行流程。</p><p>通过前面几篇文章的学习，想必你已经知道了如何通过执行上下文来分析代码的执行流程了。那么当这段代码执行到 bar 函数内部时，其调用栈的状态图如下所示：</p><p><img src="https://static001.geekbang.org/resource/image/87/f7/87d8bbc2bb62b03131802fba074146f7.png" alt="执行 bar 函数时的调用栈"></p><p>从图中可以看出，全局执行上下文和 foo 函数的执行上下文中都包含变量 myName，那 bar 函数里面 myName 的值到底该选择哪个呢？</p><p>也许你的第一反应是按照调用栈的顺序来查找变量，查找方式如下：</p><ol><li><p>先查找栈顶是否存在 myName 变量，但是这里没有，所以接着往下查找 foo 函数中的变量。</p></li><li><p>在 foo 函数中查找到了 myName 变量，这时候就使用 foo 函数中的 myName。</p></li></ol><p>如果按照这种方式来查找变量，那么最终执行 bar 函数打印出来的结果就应该是“极客邦”。但实际情况并非如此，如果你试着执行上述代码，你会发现打印出来的结果是“极客时间”。为什么会是这种情况呢？要解释清楚这个问题，那么你就需要先搞清楚作用域链了。</p><h2 id="作用域链" tabindex="-1"><a class="header-anchor" href="#作用域链" aria-hidden="true">#</a> 作用域链</h2><p>关于作用域链，很多人会感觉费解，但如果你理解了调用栈、执行上下文、词法环境、变量环境等概念，那么你理解起来作用域链也会很容易。所以很是建议你结合前几篇文章将上面那几个概念学习透彻。</p><p>其实在每个执行上下文的变量环境中，都包含了一个外部引用，用来指向外部的执行上下文，我们把这个外部引用称为 <strong>outer</strong>。</p><p>当一段代码使用了一个变量时，JavaScript 引擎首先会在“当前的执行上下文”中查找该变量，</p><p>比如上面那段代码在查找 myName 变量时，如果在当前的变量环境中没有查找到，那么 JavaScript 引擎会继续在 outer 所指向的执行上下文中查找。为了直观理解，你可以看下面这张图：</p><p><img src="https://static001.geekbang.org/resource/image/20/a7/20a832656434264db47c93e657e346a7.png" alt="带有外部引用的调用栈示意图"></p><p>从图中可以看出，bar 函数和 foo 函数的 outer 都是指向全局上下文的，这也就意味着如果在 bar 函数或者 foo 函数中使用了外部变量，那么 JavaScript 引擎会去全局执行上下文中查找。我们把这个查找的链条就称为<strong>作用域链</strong>。</p><p>现在你知道变量是通过作用域链来查找的了，不过还有一个疑问没有解开，foo 函数调用的 bar 函数，那为什么 bar 函数的外部引用是全局执行上下文，而不是 foo 函数的执行上下文？</p><p>要回答这个问题，你还需要知道什么是<strong>词法作用域</strong>。这是因为在 JavaScript 执行过程中，其作用域链是由词法作用域决定的。</p><h2 id="词法作用域" tabindex="-1"><a class="header-anchor" href="#词法作用域" aria-hidden="true">#</a> 词法作用域</h2><p><strong>词法作用域就是指作用域是由代码中函数声明的位置来决定的，所以词法作用域是静态的作用域，通过它就能够预测代码在执行过程中如何查找标识符。</strong></p><p>这么讲可能不太好理解，你可以看下面这张图：</p><p><img src="https://static001.geekbang.org/resource/image/21/39/216433d2d0c64149a731d84ba1a07739.png" alt="词法作用域"></p><p>从图中可以看出，词法作用域就是根据代码的位置来决定的，其中 main 函数包含了 bar 函数，bar 函数中包含了 foo 函数，因为 JavaScript 作用域链是由词法作用域决定的，所以整个词法作用域链的顺序是：foo 函数作用域—&gt;bar 函数作用域—&gt;main 函数作用域—&gt; 全局作用域。</p><p>了解了词法作用域以及 JavaScript 中的作用域链，我们再回过头来看看上面的那个问题：在开头那段代码中，foo 函数调用了 bar 函数，那为什么 bar 函数的外部引用是全局执行上下文，而不是 foo 函数的执行上下文?</p><p>这是因为根据词法作用域，foo 和 bar 的上级作用域都是全局作用域，所以如果 foo 或者 bar 函数使用了一个它们没有定义的变量，那么它们会到全局作用域去查找。也就是说，<strong>词法作用域是代码编译阶段就决定好的，和函数是怎么调用的没有关系</strong>。</p><h2 id="块级作用域中的变量查找" tabindex="-1"><a class="header-anchor" href="#块级作用域中的变量查找" aria-hidden="true">#</a> 块级作用域中的变量查找</h2><p>前面我们通过全局作用域和函数级作用域来分析了作用域链，那接下来我们再来看看块级作用域中变量是如何查找的？在编写代码的时候，如果你使用了一个在当前作用域中不存在的变量，这时 JavaScript 引擎就需要按照作用域链在其他作用域中查找该变量，如果你不了解该过程，那就会有很大概率写出不稳定的代码。</p><p>我们还是先看下面这段代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客世界&quot;</span>
  <span class="token keyword">let</span> test1 <span class="token operator">=</span> <span class="token number">100</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> myName <span class="token operator">=</span> <span class="token string">&quot;Chrome浏览器&quot;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客邦&quot;</span>
  <span class="token keyword">let</span> test <span class="token operator">=</span> <span class="token number">2</span>

  <span class="token punctuation">{</span>
  <span class="token keyword">let</span> test <span class="token operator">=</span> <span class="token number">3</span>
  <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">var</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span>
<span class="token keyword">let</span> myAge <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">let</span> test <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>你可以自己先分析下这段代码的执行流程，看看能否分析出来执行结果。</p><p>要想得出其执行结果，那接下来我们就得站在作用域链和词法环境的角度来分析下其执行过程。</p><p>在<a href="/guide/09" target="_blank" rel="noopener noreferrer">上篇文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>中我们已经介绍过了，ES6 是支持块级作用域的，当执行到代码块时，如果代码块中有 let 或者 const 声明的变量，那么变量就会存放到该函数的词法环境中。对于上面这段代码，当执行到 bar 函数内部的 if 语句块时，其调用栈的情况如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/25/a7/25053af5ae30c8be991fa14631cde0a7.png" alt="块级作用域中是如何查找变量的"></p><p>现在是执行到 bar 函数的 if 语块之内，需要打印出来变量 test，那么就需要查找到 test 变量的值，其查找过程我已经在上图中使用序号 1、2、3、4、5 标记出来了。</p><p>下面我就来解释下这个过程。首先是在 bar 函数的执行上下文中查找，但因为 bar 函数的执行上下文中没有定义 test 变量，所以根据词法作用域的规则，下一步就在 bar 函数的外部作用域中查找，也就是全局作用域。</p><p>至于单个执行上下文中如何查找变量，我在上一篇文章中已经做了介绍，这里就不重复了。</p><h2 id="闭包" tabindex="-1"><a class="header-anchor" href="#闭包" aria-hidden="true">#</a> 闭包</h2><p>了解了作用域链，接着我们就可以来聊聊闭包了。关于闭包，理解起来可能会是一道坎，特别是在你不太熟悉 JavaScript 这门语言的时候，接触闭包很可能会让你产生一些挫败感，因为你很难通过理解背后的原理来彻底理解闭包，从而导致学习过程中似乎总是似懂非懂。最要命的是，JavaScript 代码中还总是充斥着大量的闭包代码。</p><p>但理解了变量环境、词法环境和作用域链等概念，那接下来你再理解什么是 JavaScript 中的闭包就容易多了。这里你可以结合下面这段代码来理解什么是闭包：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span>
  <span class="token keyword">let</span> test1 <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">const</span> test2 <span class="token operator">=</span> <span class="token number">2</span>
  <span class="token keyword">var</span> innerBar <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">getName</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span>
      <span class="token keyword">return</span> myName
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setName</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newName</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      myName <span class="token operator">=</span> newName
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> innerBar
<span class="token punctuation">}</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
bar<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;极客邦&quot;</span><span class="token punctuation">)</span>
bar<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>首先我们看看当执行到 foo 函数内部的return innerBar这行代码时调用栈的情况，你可以参考下图：</p><p><img src="https://static001.geekbang.org/resource/image/d5/ef/d5587b76427a56c5f0b0571e4264b7ef.png" alt="执行到 return bar 时候的调用栈"></p><p>从上面的代码可以看出，innerBar 是一个对象，包含了 getName 和 setName 的两个方法（通常我们把对象内部的函数称为方法）。你可以看到，这两个方法都是在 foo 函数内部定义的，并且这两个方法内部都使用了 myName 和 test1 两个变量。</p><p><strong>根据词法作用域的规则，内部函数 getName 和 setName 总是可以访问它们的外部函数 foo 中的变量</strong>，所以当 innerBar 对象返回给全局变量 bar 时，虽然 foo 函数已经执行结束，但是 getName 和 setName 函数依然可以使用 foo 函数中的变量 myName 和 test1。所以当 foo 函数执行完成之后，其整个调用栈的状态如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/ee/3f/ee7c1ca481875ad4bdeb4383bd1f883f.png" alt="闭包的产生过程"></p><p>从上图可以看出，foo 函数执行完成之后，其执行上下文从栈顶弹出了，但是由于返回的 setName 和 getName 方法中使用了 foo 函数内部的变量 myName 和 test1，所以这两个变量依然保存在内存中。这像极了 setName 和 getName 方法背的一个专属背包，无论在哪里调用了 setName 和 getName 方法，它们都会背着这个 foo 函数的专属背包。</p><p>之所以是<strong>专属</strong>背包，是因为除了 setName 和 getName 函数之外，其他任何地方都是无法访问该背包的，我们就可以把这个背包称为 foo 函数的<strong>闭包</strong>。</p><p>好了，现在我们终于可以给闭包一个正式的定义了。<strong>在 JavaScript 中，根据词法作用域的规则，内部函数总是可以访问其外部函数中声明的变量，当通过调用一个外部函数返回一个内部函数后，即使该外部函数已经执行结束了，但是内部函数引用外部函数的变量依然保存在内存中，我们就把这些变量的集合称为闭包。比如外部函数是 foo，那么这些变量的集合就称为 foo 函数的闭包。</strong></p><p>那这些闭包是如何使用的呢？当执行到 bar.setName 方法中的myName = &quot;极客邦&quot;这句代码时，JavaScript 引擎会沿着“当前执行上下文–&gt;foo 函数闭包–&gt; 全局执行上下文”的顺序来查找 myName 变量，你可以参考下面的调用栈状态图：</p><p><img src="https://static001.geekbang.org/resource/image/50/46/50e4ba60fc7e420e83b35b95e379b246.png" alt="执行 bar 时调用栈状态"></p><p>从图中可以看出，setName 的执行上下文中没有 myName 变量，foo 函数的闭包中包含了变量 myName，所以调用 setName 时，会修改 foo 闭包中的 myName 变量的值。</p><p>同样的流程，当调用 bar.getName 的时候，所访问的变量 myName 也是位于 foo 函数闭包中的。</p><p>你也可以通过“开发者工具”来看看闭包的情况，打开 Chrome 的“开发者工具”，在 bar 函数任意地方打上断点，然后刷新页面，可以看到如下内容：</p><p><img src="https://static001.geekbang.org/resource/image/40/a8/40b8840480a5df4f43ad5f4e7907e3a8.png" alt="开发者工具中的闭包展示"></p><p>从图中可以看出来，当调用 bar.getName 的时候，右边 Scope 项就体现出了作用域链的情况：Local 就是当前的 getName 函数的作用域，Closure(foo) 是指 foo 函数的闭包，最下面的 Global 就是指全局作用域，从“Local–&gt;Closure(foo)–&gt;Global”就是一个完整的作用域链。</p><p>所以说，你以后也可以通过 Scope 来查看实际代码作用域链的情况，这样调试代码也会比较方便。</p><h2 id="闭包是怎么回收的" tabindex="-1"><a class="header-anchor" href="#闭包是怎么回收的" aria-hidden="true">#</a> 闭包是怎么回收的</h2><p>理解什么是闭包之后，接下来我们再来简单聊聊闭包是什么时候销毁的。因为如果闭包使用不正确，会很容易造成内存泄漏的，关注闭包是如何回收的能让你正确地使用闭包。</p><p>通常，如果引用闭包的函数是一个全局变量，那么闭包会一直存在直到页面关闭；但如果这个闭包以后不再使用的话，就会造成内存泄漏。</p><p>如果引用闭包的函数是个局部变量，等函数销毁后，在下次 JavaScript 引擎执行垃圾回收时，判断闭包这块内容如果已经不再被使用了，那么 JavaScript 引擎的垃圾回收器就会回收这块内存。</p><p>所以在使用闭包的时候，你要尽量注意一个原则：如果该闭包会一直使用，那么它可以作为全局变量而存在；但如果使用频率不高，而且占用内存又比较大的话，那就尽量让它成为一个局部变量。</p><p>关于闭包回收的问题本文只是做了个简单的介绍，其实闭包是如何回收的还牵涉到了 JavaScript 的垃圾回收机制，而关于垃圾回收，后续章节我会再为你做详细介绍的。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>好了，今天的内容就讲到这里，下面我们来回顾下今天的内容：</p><ul><li><p>首先，介绍了什么是作用域链，我们把通过作用域查找变量的链条称为作用域链；作用域链是通过词法作用域来确定的，而词法作用域反映了代码的结构。</p></li><li><p>其次，介绍了在块级作用域中是如何通过作用域链来查找变量的。</p></li><li><p>最后，又基于作用域链和词法环境介绍了到底什么是闭包。</p></li></ul><p>通过展开词法作用域，我们介绍了 JavaScript 中的作用域链和闭包；通过词法作用域，我们分析了在 JavaScript 的执行过程中，作用域链是已经注定好了，比如即使在 foo 函数中调用了 bar 函数，你也无法在 bar 函数中直接使用 foo 函数中的变量信息。</p><p>因此理解词法作用域对于你理解 JavaScript 语言本身有着非常大帮助，比如有助于你理解下一篇文章中要介绍的 this。另外，理解词法作用域对于你理解其他语言也有很大的帮助，因为它们的逻辑都是一样的。</p><h2 id="思考时间" tabindex="-1"><a class="header-anchor" href="#思考时间" aria-hidden="true">#</a> 思考时间</h2><p>今天留给你的思考题是关于词法作用域和闭包，我修改了上面那段产生闭包的代码，如下所示：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">myName</span><span class="token operator">:</span><span class="token string">&quot;time.geekbang.com&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">printName</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span>
  <span class="token keyword">return</span> bar<span class="token punctuation">.</span>printName
<span class="token punctuation">}</span>
<span class="token keyword">let</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客邦&quot;</span>
<span class="token keyword">let</span> _printName <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">_printName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
bar<span class="token punctuation">.</span><span class="token function">printName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在上面这段代码中有三个地方定义了 myName，分析这段代码，你觉得这段代码在执行过程中会产生闭包吗？最终打印的结果是什么？</p><p>欢迎在留言区与我分享你的想法，也欢迎你在留言区记录你的思考过程。感谢阅读，如果你觉得这篇文章对你有帮助的话，也欢迎把它分享给更多的朋友。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: kaiwei.zh@qq.com">Zhang Kaiwei</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/broswer-working-principle/assets/app.7d025128.js" defer></script>
  </body>
</html>
