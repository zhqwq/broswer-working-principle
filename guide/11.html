<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.43">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>11 | this：从JavaScript执行上下文的视角讲清楚this | 浏览器工作原理与实践</title><meta name="description" content="浏览器工作原理与实践 - 李兵">
    <link rel="modulepreload" href="/broswer-working-principle/assets/app.7d025128.js"><link rel="modulepreload" href="/broswer-working-principle/assets/11.html.6ac48bbc.js"><link rel="modulepreload" href="/broswer-working-principle/assets/11.html.cf85adc2.js"><link rel="prefetch" href="/broswer-working-principle/assets/index.html.82a93635.js"><link rel="prefetch" href="/broswer-working-principle/assets/01.html.c8da2b6e.js"><link rel="prefetch" href="/broswer-working-principle/assets/02.html.b244f45e.js"><link rel="prefetch" href="/broswer-working-principle/assets/03.html.7e296279.js"><link rel="prefetch" href="/broswer-working-principle/assets/04.html.44afb11e.js"><link rel="prefetch" href="/broswer-working-principle/assets/05.html.1f43d153.js"><link rel="prefetch" href="/broswer-working-principle/assets/06.html.6a2487c3.js"><link rel="prefetch" href="/broswer-working-principle/assets/07.html.647743fb.js"><link rel="prefetch" href="/broswer-working-principle/assets/08.html.57921165.js"><link rel="prefetch" href="/broswer-working-principle/assets/09.html.dda209e4.js"><link rel="prefetch" href="/broswer-working-principle/assets/10.html.cdbb583c.js"><link rel="prefetch" href="/broswer-working-principle/assets/12.html.2521bbd1.js"><link rel="prefetch" href="/broswer-working-principle/assets/13.html.5c6deb69.js"><link rel="prefetch" href="/broswer-working-principle/assets/14.html.381267b1.js"><link rel="prefetch" href="/broswer-working-principle/assets/15.html.d3bd7be0.js"><link rel="prefetch" href="/broswer-working-principle/assets/16.html.d4f45e08.js"><link rel="prefetch" href="/broswer-working-principle/assets/17.html.57b8bd68.js"><link rel="prefetch" href="/broswer-working-principle/assets/18.html.1217ca1a.js"><link rel="prefetch" href="/broswer-working-principle/assets/19.html.645019c0.js"><link rel="prefetch" href="/broswer-working-principle/assets/20.html.e03efe45.js"><link rel="prefetch" href="/broswer-working-principle/assets/21.html.dcf257c9.js"><link rel="prefetch" href="/broswer-working-principle/assets/22.html.a3207225.js"><link rel="prefetch" href="/broswer-working-principle/assets/23.html.8121c388.js"><link rel="prefetch" href="/broswer-working-principle/assets/24.html.ab97fcb7.js"><link rel="prefetch" href="/broswer-working-principle/assets/25.html.21ccb19a.js"><link rel="prefetch" href="/broswer-working-principle/assets/26.html.2820a164.js"><link rel="prefetch" href="/broswer-working-principle/assets/27.html.d258fbff.js"><link rel="prefetch" href="/broswer-working-principle/assets/28.html.0783965d.js"><link rel="prefetch" href="/broswer-working-principle/assets/29.html.a3b531ba.js"><link rel="prefetch" href="/broswer-working-principle/assets/30.html.b8d39ad6.js"><link rel="prefetch" href="/broswer-working-principle/assets/31.html.a60f2960.js"><link rel="prefetch" href="/broswer-working-principle/assets/32.html.8f867d89.js"><link rel="prefetch" href="/broswer-working-principle/assets/33.html.f4fa6306.js"><link rel="prefetch" href="/broswer-working-principle/assets/34.html.8253388f.js"><link rel="prefetch" href="/broswer-working-principle/assets/35.html.287f2d25.js"><link rel="prefetch" href="/broswer-working-principle/assets/36.html.ede0a3e5.js"><link rel="prefetch" href="/broswer-working-principle/assets/end.html.ea97750b.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-1.html.a71eceff.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-2.html.b5c1ee50.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-3.html.024134a8.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-4.html.c8992c4b.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-5.html.8581eac6.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-6.html.d972a33a.js"><link rel="prefetch" href="/broswer-working-principle/assets/intro.html.45f3f741.js"><link rel="prefetch" href="/broswer-working-principle/assets/404.html.93146c89.js"><link rel="prefetch" href="/broswer-working-principle/assets/index.html.997b679f.js"><link rel="prefetch" href="/broswer-working-principle/assets/01.html.c7ced5d9.js"><link rel="prefetch" href="/broswer-working-principle/assets/02.html.7de524fe.js"><link rel="prefetch" href="/broswer-working-principle/assets/03.html.084ad8b6.js"><link rel="prefetch" href="/broswer-working-principle/assets/04.html.b2354030.js"><link rel="prefetch" href="/broswer-working-principle/assets/05.html.768eef31.js"><link rel="prefetch" href="/broswer-working-principle/assets/06.html.01294057.js"><link rel="prefetch" href="/broswer-working-principle/assets/07.html.394294f1.js"><link rel="prefetch" href="/broswer-working-principle/assets/08.html.35818143.js"><link rel="prefetch" href="/broswer-working-principle/assets/09.html.6ca2b3ec.js"><link rel="prefetch" href="/broswer-working-principle/assets/10.html.23bc7225.js"><link rel="prefetch" href="/broswer-working-principle/assets/12.html.f31dac47.js"><link rel="prefetch" href="/broswer-working-principle/assets/13.html.350478c6.js"><link rel="prefetch" href="/broswer-working-principle/assets/14.html.e9d1ded5.js"><link rel="prefetch" href="/broswer-working-principle/assets/15.html.2ad3b8f6.js"><link rel="prefetch" href="/broswer-working-principle/assets/16.html.a635e4ef.js"><link rel="prefetch" href="/broswer-working-principle/assets/17.html.f0e288cf.js"><link rel="prefetch" href="/broswer-working-principle/assets/18.html.7bc35d97.js"><link rel="prefetch" href="/broswer-working-principle/assets/19.html.7e1046f7.js"><link rel="prefetch" href="/broswer-working-principle/assets/20.html.9a6908cc.js"><link rel="prefetch" href="/broswer-working-principle/assets/21.html.94648f8d.js"><link rel="prefetch" href="/broswer-working-principle/assets/22.html.36565699.js"><link rel="prefetch" href="/broswer-working-principle/assets/23.html.6bee3b29.js"><link rel="prefetch" href="/broswer-working-principle/assets/24.html.b9b53c8e.js"><link rel="prefetch" href="/broswer-working-principle/assets/25.html.08060580.js"><link rel="prefetch" href="/broswer-working-principle/assets/26.html.573c95e7.js"><link rel="prefetch" href="/broswer-working-principle/assets/27.html.85f9dbe2.js"><link rel="prefetch" href="/broswer-working-principle/assets/28.html.1cf9ad54.js"><link rel="prefetch" href="/broswer-working-principle/assets/29.html.5b86ec75.js"><link rel="prefetch" href="/broswer-working-principle/assets/30.html.66dedd16.js"><link rel="prefetch" href="/broswer-working-principle/assets/31.html.773e7089.js"><link rel="prefetch" href="/broswer-working-principle/assets/32.html.c8d576df.js"><link rel="prefetch" href="/broswer-working-principle/assets/33.html.1d6c51ac.js"><link rel="prefetch" href="/broswer-working-principle/assets/34.html.180e3126.js"><link rel="prefetch" href="/broswer-working-principle/assets/35.html.07872742.js"><link rel="prefetch" href="/broswer-working-principle/assets/36.html.a3b639b6.js"><link rel="prefetch" href="/broswer-working-principle/assets/end.html.f3ed0f1e.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-1.html.887f657f.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-2.html.11ddfc46.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-3.html.89b72768.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-4.html.e5aa1927.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-5.html.ac7ead75.js"><link rel="prefetch" href="/broswer-working-principle/assets/extra-6.html.f82266a6.js"><link rel="prefetch" href="/broswer-working-principle/assets/intro.html.8d1d1025.js"><link rel="prefetch" href="/broswer-working-principle/assets/404.html.bd43ddad.js"><link rel="prefetch" href="/broswer-working-principle/assets/404.d1126912.js"><link rel="prefetch" href="/broswer-working-principle/assets/Layout.7bd61645.js">
    <link rel="stylesheet" href="/broswer-working-principle/assets/style.8d3ba15e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/broswer-working-principle/" class=""><!----><span class="site-name">浏览器工作原理与实践</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/broswer-working-principle/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/broswer-working-principle/guide/intro" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/broswer-working-principle/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/broswer-working-principle/guide/intro" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">开篇词 (1讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/intro" class="sidebar-item" aria-label="开篇词 | 参透了浏览器的工作原理, 你就能解决80%的前端难题"><!--[--><!--]--> 开篇词 | 参透了浏览器的工作原理, 你就能解决80%的前端难题 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">宏观视角下的浏览器 (6讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/01" class="sidebar-item" aria-label="01 | Chrome架构: 仅仅打开了1个页面, 为什么有4个进程"><!--[--><!--]--> 01 | Chrome架构: 仅仅打开了1个页面, 为什么有4个进程 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/02" class="sidebar-item" aria-label="02 | TCP协议: 如何保证页面文件能被完整送达浏览器?"><!--[--><!--]--> 02 | TCP协议: 如何保证页面文件能被完整送达浏览器? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/03" class="sidebar-item" aria-label="03 | HTTP请求流程: 为什么很多站点第二次打开速度会很快?"><!--[--><!--]--> 03 | HTTP请求流程: 为什么很多站点第二次打开速度会很快? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/04" class="sidebar-item" aria-label="04 | 导航流程: 从输入URL到页面展示, 这中间发生了什么?"><!--[--><!--]--> 04 | 导航流程: 从输入URL到页面展示, 这中间发生了什么? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/05" class="sidebar-item" aria-label="05 | 渲染流程(上): HTML、CSS和JavaScript, 是如何变成页面的?"><!--[--><!--]--> 05 | 渲染流程(上): HTML、CSS和JavaScript, 是如何变成页面的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/06" class="sidebar-item" aria-label="06 | 渲染流程(下): HTML、CSS和JavaScript, 是如何变成页面的?"><!--[--><!--]--> 06 | 渲染流程(下): HTML、CSS和JavaScript, 是如何变成页面的? <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">浏览器中的JavaScript执行机制 (5讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/07" class="sidebar-item" aria-label="07 | 变量提升: JavaScript代码是按顺序执行的吗?"><!--[--><!--]--> 07 | 变量提升: JavaScript代码是按顺序执行的吗? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/08" class="sidebar-item" aria-label="08 | 调用栈: 为什么JavaScript代码会出现栈溢出?"><!--[--><!--]--> 08 | 调用栈: 为什么JavaScript代码会出现栈溢出? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/09" class="sidebar-item" aria-label="09 | 块级作用域: var缺陷以及为什么要引入let和const?"><!--[--><!--]--> 09 | 块级作用域: var缺陷以及为什么要引入let和const? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/10" class="sidebar-item" aria-label="10 | 作用域链和闭包: 代码中出现相同的变量,JavaScript引擎是如何选择的?"><!--[--><!--]--> 10 | 作用域链和闭包: 代码中出现相同的变量,JavaScript引擎是如何选择的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/11" class="router-link-active sidebar-item active" aria-label="11 | this: 从JavaScript执行上下文的视角讲清楚this"><!--[--><!--]--> 11 | this: 从JavaScript执行上下文的视角讲清楚this <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">V8工作原理 (3讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/12" class="sidebar-item" aria-label="12 | 栈空间和堆空间：数据是如何存储的？"><!--[--><!--]--> 12 | 栈空间和堆空间：数据是如何存储的？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/13" class="sidebar-item" aria-label="13 | 垃圾回收：垃圾数据是如何自动回收的？"><!--[--><!--]--> 13 | 垃圾回收：垃圾数据是如何自动回收的？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/14" class="sidebar-item" aria-label="14 | 编译器和解释器: V8是如何执行一段JavaScript代码的?"><!--[--><!--]--> 14 | 编译器和解释器: V8是如何执行一段JavaScript代码的? <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器中的页面循环系统 (6讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/15" class="sidebar-item" aria-label="15 | 消息队列和事件循环：页面是怎么“活”起来的？"><!--[--><!--]--> 15 | 消息队列和事件循环：页面是怎么“活”起来的？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/16" class="sidebar-item" aria-label="16 | WebAPI: setTimeout是如何实现的?"><!--[--><!--]--> 16 | WebAPI: setTimeout是如何实现的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/17" class="sidebar-item" aria-label="17 | WebAPI: XMLHttpRequest是怎么实现的?"><!--[--><!--]--> 17 | WebAPI: XMLHttpRequest是怎么实现的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/18" class="sidebar-item" aria-label="18 | 宏任务和微任务：不是所有任务都是一个待遇"><!--[--><!--]--> 18 | 宏任务和微任务：不是所有任务都是一个待遇 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/18" class="sidebar-item" aria-label="18 | 宏任务和微任务：不是所有任务都是一个待遇"><!--[--><!--]--> 18 | 宏任务和微任务：不是所有任务都是一个待遇 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/19" class="sidebar-item" aria-label="19 | Promise: 使用Promise, 告别回调函数"><!--[--><!--]--> 19 | Promise: 使用Promise, 告别回调函数 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/20" class="sidebar-item" aria-label="20 | async/await: 使用同步的方式去写异步代码"><!--[--><!--]--> 20 | async/await: 使用同步的方式去写异步代码 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器中的页面 (8讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/21" class="sidebar-item" aria-label="21 | Chrome开发者工具: 利用网络面板做性能分析"><!--[--><!--]--> 21 | Chrome开发者工具: 利用网络面板做性能分析 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/22" class="sidebar-item" aria-label="22 | DOM树: JavaScript是如何影响DOM树构建的?"><!--[--><!--]--> 22 | DOM树: JavaScript是如何影响DOM树构建的? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/23" class="sidebar-item" aria-label="23 | 渲染流水线: CSS如何影响首次加载时的白屏时间?"><!--[--><!--]--> 23 | 渲染流水线: CSS如何影响首次加载时的白屏时间? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/24" class="sidebar-item" aria-label="24 | 分层和合成机制: 为什么CSS动画比JavaScript高效?"><!--[--><!--]--> 24 | 分层和合成机制: 为什么CSS动画比JavaScript高效? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/25" class="sidebar-item" aria-label="25 | 页面性能：如何系统地优化页面？"><!--[--><!--]--> 25 | 页面性能：如何系统地优化页面？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/26" class="sidebar-item" aria-label="26 | 虚拟DOM: 虚拟DOM和实际的DOM有何不同?"><!--[--><!--]--> 26 | 虚拟DOM: 虚拟DOM和实际的DOM有何不同? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/27" class="sidebar-item" aria-label="27 | 渐进式网页应用(PWA): 它究竟解决了Web应用的哪些问题?"><!--[--><!--]--> 27 | 渐进式网页应用(PWA): 它究竟解决了Web应用的哪些问题? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/28" class="sidebar-item" aria-label="28 | WebComponent: 像搭积木一样构建Web应用"><!--[--><!--]--> 28 | WebComponent: 像搭积木一样构建Web应用 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器中的网络 (3讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/29" class="sidebar-item" aria-label="29 | HTTP/1: HTTP性能优化"><!--[--><!--]--> 29 | HTTP/1: HTTP性能优化 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/30" class="sidebar-item" aria-label="30 | HTTP/2: 如何提升网络速度？"><!--[--><!--]--> 30 | HTTP/2: 如何提升网络速度？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/31" class="sidebar-item" aria-label="31|HTTP/3:甩掉TCP、TLS 的包袱，构建高效网络"><!--[--><!--]--> 31|HTTP/3:甩掉TCP、TLS 的包袱，构建高效网络 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">浏览器安全 (5讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/32" class="sidebar-item" aria-label="32 | 同源策略: 为什么XMLHttpRequest不能跨域请求资源?"><!--[--><!--]--> 32 | 同源策略: 为什么XMLHttpRequest不能跨域请求资源? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/33" class="sidebar-item" aria-label="33 | 跨站脚本攻击(XSS): 为什么Cookie中有HttpOnly属性?"><!--[--><!--]--> 33 | 跨站脚本攻击(XSS): 为什么Cookie中有HttpOnly属性? <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/34" class="sidebar-item" aria-label="34 | CSRF攻击: 陌生链接不要随便点"><!--[--><!--]--> 34 | CSRF攻击: 陌生链接不要随便点 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/35" class="sidebar-item" aria-label="35 | 安全沙箱：页面和系统之间的隔离墙"><!--[--><!--]--> 35 | 安全沙箱：页面和系统之间的隔离墙 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/36" class="sidebar-item" aria-label="36 | HTTPS: 让数据传输更安全"><!--[--><!--]--> 36 | HTTPS: 让数据传输更安全 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">结束语 (3讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/end" class="sidebar-item" aria-label="结束语 | 大道至简"><!--[--><!--]--> 结束语 | 大道至简 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">课外加餐 (6讲) <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/broswer-working-principle/guide/extra-1" class="sidebar-item" aria-label="加餐一｜浏览上下文组：如何计算Chrome中渲染进程的个数？"><!--[--><!--]--> 加餐一｜浏览上下文组：如何计算Chrome中渲染进程的个数？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-2" class="sidebar-item" aria-label="加餐二｜任务调度：有了setTimeOut，为什么还要使用rAF？"><!--[--><!--]--> 加餐二｜任务调度：有了setTimeOut，为什么还要使用rAF？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-3" class="sidebar-item" aria-label="加餐三｜加载阶段性能：使用Audits来优化Web性能"><!--[--><!--]--> 加餐三｜加载阶段性能：使用Audits来优化Web性能 <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-4" class="sidebar-item" aria-label="加餐四｜页面性能工具：如何使用Performance？"><!--[--><!--]--> 加餐四｜页面性能工具：如何使用Performance？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-5" class="sidebar-item" aria-label="加餐五 | 性能分析工具：如何分析Performance中的Main指标？"><!--[--><!--]--> 加餐五 | 性能分析工具：如何分析Performance中的Main指标？ <!--[--><!--]--></a><!----></li><li><a href="/broswer-working-principle/guide/extra-6" class="sidebar-item" aria-label="加餐六｜HTTPS：浏览器如何验证数字证书？"><!--[--><!--]--> 加餐六｜HTTPS：浏览器如何验证数字证书？ <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="_11-this-从javascript执行上下文的视角讲清楚this" tabindex="-1"><a class="header-anchor" href="#_11-this-从javascript执行上下文的视角讲清楚this" aria-hidden="true">#</a> 11 | this：从JavaScript执行上下文的视角讲清楚this</h1><p>在<a href="/guide/10" target="_blank" rel="noopener noreferrer">上篇文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>中，我们讲了词法作用域、作用域链以及闭包，并在最后思考题中留了下面这样一段代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">myName</span><span class="token operator">:</span><span class="token string">&quot;time.geekbang.com&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">printName</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span>
  <span class="token keyword">return</span> bar<span class="token punctuation">.</span>printName
<span class="token punctuation">}</span>

<span class="token keyword">let</span> myName <span class="token operator">=</span> <span class="token string">&quot;极客邦&quot;</span>
<span class="token keyword">let</span> _printName <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">_printName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
bar<span class="token punctuation">.</span><span class="token function">printName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>相信你已经知道了，在 printName 函数里面使用的变量 myName 是属于全局作用域下面的，所以最终打印出来的值都是“极客邦”。这是因为 JavaScript 语言的作用域链是由词法作用域决定的，而词法作用域是由代码结构来确定的。</p><p>不过按照常理来说，调用bar.printName方法时，该方法内部的变量 myName 应该使用 bar 对象中的，因为它们是一个整体，大多数面向对象语言都是这样设计的，比如我用 C++ 改写了上面那段代码，如下所示：</p><div class="language-c++ ext-c++ line-numbers-mode"><pre class="language-c++"><code>#include &lt;iostream&gt;
using namespace std;

class Bar{
  public:
  char* myName;

  Bar(){

    myName = &quot;time.geekbang.com&quot;;

  }
  void printName(){
    cout&lt;&lt; myName &lt;&lt;endl;
  }
} bar;

char* myName = &quot;极客邦&quot;;
int main() {
  bar.printName();
  return 0;
}
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在这段 C++ 代码中，我同样调用了 bar 对象中的 printName 方法，最后打印出来的值就是 bar 对象的内部变量 myName 值——“time.geekbang.com”，而并不是最外面定义变量 myName 的值——“极客邦”，所以<strong>在对象内部的方法中使用对象内部的属性是一个非常普遍的需求</strong>。但是 JavaScript 的作用域机制并不支持这一点，基于这个需求，JavaScript 又搞出来另外一套 <strong>this 机制</strong>。</p><p>所以，在 JavaScript 中可以使用 this 实现在 printName 函数中访问到 bar 对象的 myName 属性了。具体该怎么操作呢？你可以调整 printName 的代码，如下所示：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">printName</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>myName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来咱们就展开来介绍 this，不过在讲解之前，希望你能区分清楚<strong>作用域链</strong>和 <strong>this</strong> 是两套不同的系统，它们之间基本没太多联系。在前期明确这点，可以避免你在学习 this 的过程中，和作用域产生一些不必要的关联。</p><h2 id="javascript-中的-this-是什么" tabindex="-1"><a class="header-anchor" href="#javascript-中的-this-是什么" aria-hidden="true">#</a> JavaScript 中的 this 是什么</h2><p>关于 this，我们还是得先从执行上下文说起。在前面几篇文章中，我们提到执行上下文中包含了变量环境、词法环境、外部环境，但其实还有一个 this 没有提及，具体你可以参考下图：</p><p><img src="https://static001.geekbang.org/resource/image/b3/8d/b398610fd8060b381d33afc9b86f988d.png" alt="执行上下文中的 this"></p><p>从图中可以看出，<strong>this 是和执行上下文绑定的</strong>，也就是说每个执行上下文中都有一个 this。前面<a href="/guide/08" target="_blank" rel="noopener noreferrer">《08 | 调用栈：为什么 JavaScript 代码会出现栈溢出？》<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>中我们提到过，执行上下文主要分为三种——全局执行上下文、函数执行上下文和 eval 执行上下文，所以对应的 this 也只有这三种——全局执行上下文中的 this、函数中的 this 和 eval 中的 this。</p><p>不过由于 eval 我们使用的不多，所以本文我们对此就不做介绍了，如果你感兴趣的话，可以自行搜索和学习相关知识。</p><p>那么接下来我们就重点讲解下<strong>全局执行上下文中的 this</strong> 和<strong>函数执行上下文中的 this。</strong></p><h2 id="全局执行上下文中的-this" tabindex="-1"><a class="header-anchor" href="#全局执行上下文中的-this" aria-hidden="true">#</a> 全局执行上下文中的 this</h2><p>首先我们来看看全局执行上下文中的 this 是什么。</p><p>你可以在控制台中输入console.log(this)来打印出来全局执行上下文中的 this，最终输出的是 window 对象。所以你可以得出这样一个结论：全局执行上下文中的 this 是指向 window 对象的。这也是 this 和作用域链的唯一交点，作用域链的最底端包含了 window 对象，全局执行上下文中的 this 也是指向 window 对象。</p><h2 id="函数执行上下文中的-this" tabindex="-1"><a class="header-anchor" href="#函数执行上下文中的-this" aria-hidden="true">#</a> 函数执行上下文中的 this</h2><p>现在你已经知道全局对象中的 this 是指向 window 对象了，那么接下来，我们就来重点分析函数执行上下文中的 this。还是先看下面这段代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们在 foo 函数内部打印出来 this 值，执行这段代码，打印出来的也是 window 对象，这说明在默认情况下调用一个函数，其执行上下文中的 this 也是指向 window 对象的。估计你会好奇，那能不能设置执行上下文中的 this 来指向其他对象呢？答案是肯定的。通常情况下，有下面三种方式来设置函数执行上下文中的 this 值。</p><h3 id="_1-通过函数的-call-方法设置" tabindex="-1"><a class="header-anchor" href="#_1-通过函数的-call-方法设置" aria-hidden="true">#</a> 1. 通过函数的 call 方法设置</h3><p>你可以通过函数的 <strong>call</strong> 方法来设置函数执行上下文的 this 指向，比如下面这段代码，我们就并没有直接调用 foo 函数，而是调用了 foo 的 call 方法，并将 bar 对象作为 call 方法的参数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> bar <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">myName</span> <span class="token operator">:</span> <span class="token string">&quot;极客邦&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">test1</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>myName <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myName<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>执行这段代码，然后观察输出结果，你就能发现 foo 函数内部的 this 已经指向了 bar 对象，因为通过打印 bar 对象，可以看出 bar 的 myName 属性已经由“极客邦”变为“极客时间”了，同时在全局执行上下文中打印 myName，JavaScript 引擎提示该变量未定义。</p><p>其实除了 call 方法，你还可以使用 <strong>bind</strong> 和 <strong>apply</strong> 方法来设置函数执行上下文中的 this，它们在使用上还是有一些区别的，如果感兴趣你可以自行搜索和学习它们的使用方法，这里我就不再赘述了。</p><h3 id="_2-通过对象调用方法设置" tabindex="-1"><a class="header-anchor" href="#_2-通过对象调用方法设置" aria-hidden="true">#</a> 2. 通过对象调用方法设置</h3><p>要改变函数执行上下文中的 this 指向，除了通过函数的 call 方法来实现外，还可以通过对象调用的方式，比如下面这段代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span> <span class="token operator">:</span> <span class="token string">&quot;极客时间&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">showThis</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
myObj<span class="token punctuation">.</span><span class="token function">showThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在这段代码中，我们定义了一个 myObj 对象，该对象是由一个 name 属性和一个 showThis 方法组成的，然后再通过 myObj 对象来调用 showThis 方法。执行这段代码，你可以看到，最终输出的 this 值是指向 myObj 的。</p><p>所以，你可以得出这样的结论：<strong>使用对象来调用其内部的一个方法，该方法的 this 是指向对象本身的</strong>。</p><p>其实，你也可以认为 JavaScript 引擎在执行myObject.showThis()时，将其转化为了：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>myObj<span class="token punctuation">.</span><span class="token function">showThis</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>myObj<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>接下来我们稍微改变下调用方式，把 showThis 赋给一个全局对象，然后再调用该对象，代码如下所示：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span> <span class="token operator">:</span> <span class="token string">&quot;极客时间&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">showThis</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;极客邦&quot;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> myObj<span class="token punctuation">.</span>showThis
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>执行这段代码，你会发现 this 又指向了全局 window 对象。</p><p>所以通过以上两个例子的对比，你可以得出下面这样两个结论：</p><ul><li><p><strong>在全局环境中调用一个函数，函数内部的 this 指向的是全局变量 window。</strong></p></li><li><p><strong>通过一个对象来调用其内部的一个方法，该方法的执行上下文中的 this 指向对象本身。</strong></p></li></ul><h3 id="_3-通过构造函数中设置" tabindex="-1"><a class="header-anchor" href="#_3-通过构造函数中设置" aria-hidden="true">#</a> 3. 通过构造函数中设置</h3><p>你可以像这样设置构造函数中的 this，如下面的示例代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">CreateObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;极客时间&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在这段代码中，我们使用 new 创建了对象 myObj，那你知道此时的构造函数 CreateObj 中的 this 到底指向了谁吗？</p><p>其实，当执行 new CreateObj() 的时候，JavaScript 引擎做了如下四件事：</p><ul><li><p>首先创建了一个空对象 tempObj；</p></li><li><p>接着调用 CreateObj.call 方法，并将 tempObj 作为 call 方法的参数，这样当 CreateObj 的执行上下文创建时，它的 this 就指向了 tempObj 对象；</p></li><li><p>然后执行 CreateObj 函数，此时的 CreateObj 函数执行上下文中的 this 指向了 tempObj 对象；</p></li><li><p>最后返回 tempObj 对象。</p></li></ul><p>为了直观理解，我们可以用代码来演示下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>var tempObj = {}
CreateObj.call(tempObj)
return tempObj
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样，我们就通过 new 关键字构建好了一个新对象，并且构造函数中的 this 其实就是新对象本身。</p><p>关于 new 的具体细节你可以参考这篇文章，这里我就不做过多介绍了。</p><h2 id="this-的设计缺陷以及应对方案" tabindex="-1"><a class="header-anchor" href="#this-的设计缺陷以及应对方案" aria-hidden="true">#</a> this 的设计缺陷以及应对方案</h2><p>就我个人而言，this 并不是一个很好的设计，因为它的很多使用方法都冲击人的直觉，在使用过程中存在着非常多的坑。下面咱们就来一起看看那些 this 设计缺陷。</p><h3 id="_1-嵌套函数中的-this-不会从外层函数中继承" tabindex="-1"><a class="header-anchor" href="#_1-嵌套函数中的-this-不会从外层函数中继承" aria-hidden="true">#</a> 1. 嵌套函数中的 this 不会从外层函数中继承</h3><p>我认为这是一个严重的设计错误，并影响了后来的很多开发者，让他们“前赴后继”迷失在该错误中。我们还是结合下面这样一段代码来分析下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span> <span class="token operator">:</span> <span class="token string">&quot;极客时间&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">showThis</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
myObj<span class="token punctuation">.</span><span class="token function">showThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们在这段代码的 showThis 方法里面添加了一个 bar 方法，然后接着在 showThis 函数中调用了 bar 函数，那么现在的问题是：bar 函数中的 this 是什么？</p><p>如果你是刚接触 JavaScript，那么你可能会很自然地觉得，bar 中的 this 应该和其外层 showThis 函数中的 this 是一致的，都是指向 myObj 对象的，这很符合人的直觉。但实际情况却并非如此，执行这段代码后，你会发现<strong>函数 bar 中的 this 指向的是全局 window 对象，而函数 showThis 中的 this 指向的是 myObj 对象</strong>。这就是 JavaScript 中非常容易让人迷惑的地方之一，也是很多问题的源头。</p><p><strong>你可以通过一个小技巧来解决这个问题</strong>，比如在 showThis 函数中<strong>声明一个变量 self 用来保存 this</strong>，然后在 bar 函数中使用 self，代码如下所示：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span> <span class="token operator">:</span> <span class="token string">&quot;极客时间&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">showThis</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;极客邦&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

myObj<span class="token punctuation">.</span><span class="token function">showThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myObj<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>执行这段代码，你可以看到它输出了我们想要的结果，最终 myObj 中的 name 属性值变成了“极客邦”。其实，这个方法的的本质是把 <strong>this 体系转换为了作用域的体系</strong>。</p><p>其实，<strong>你也可以使用 ES6 中的箭头函数来解决这个问题</strong>，结合下面代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span> <span class="token operator">:</span> <span class="token string">&quot;极客时间&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">showThis</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> <span class="token function-variable function">bar</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;极客邦&quot;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
myObj<span class="token punctuation">.</span><span class="token function">showThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myObj<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>执行这段代码，你会发现它也输出了我们想要的结果，也就是箭头函数 bar 里面的 this 是指向 myObj 对象的。这是因为 ES6 中的箭头函数并不会创建其自身的执行上下文，所以箭头函数中的 this 取决于它的外部函数。</p><p>通过上面的讲解，你现在应该知道了 this 没有作用域的限制，这点和变量不一样，所以嵌套函数不会从调用它的函数中继承 this，这样会造成很多不符合直觉的代码。要解决这个问题，你可以有两种思路：</p><ul><li><p>第一种是把 this 保存为一个 self 变量，再利用变量的作用域机制传递给嵌套函数。</p></li><li><p>第二种是继续使用 this，但是要把嵌套函数改为箭头函数，因为箭头函数没有自己的执行上下文，所以它会继承调用函数中的 this。</p></li></ul><h3 id="_2-普通函数中的-this-默认指向全局对象-window" tabindex="-1"><a class="header-anchor" href="#_2-普通函数中的-this-默认指向全局对象-window" aria-hidden="true">#</a> 2. 普通函数中的 this 默认指向全局对象 window</h3><p>上面我们已经介绍过了，在默认情况下调用一个函数，其执行上下文中的 this 是默认指向全局对象 window 的。</p><p>不过这个设计也是一种缺陷，因为在实际工作中，我们并不希望函数执行上下文中的 this 默认指向全局对象，因为这样会打破数据的边界，造成一些误操作。如果要让函数执行上下文中的 this 指向某个对象，最好的方式是通过 call 方法来显示调用。</p><p>这个问题可以通过设置 JavaScript 的“严格模式”来解决。在严格模式下，默认执行一个函数，其函数的执行上下文中的 this 值是 undefined，这就解决上面的问题了。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>好了，今天就到这里，下面我们来回顾下今天的内容。</p><p>首先，在使用 this 时，为了避坑，你要谨记以下三点：</p><ol><li><p>当函数作为对象的方法调用时，函数中的 this 就是该对象；</p></li><li><p>当函数被正常调用时，在严格模式下，this 值是 undefined，非严格模式下 this 指向的是全局对象 window；</p></li><li><p>嵌套函数中的 this 不会继承外层函数的 this 值。</p></li></ol><p>最后，我们还提了一下箭头函数，因为箭头函数没有自己的执行上下文，所以箭头函数的 this 就是它外层函数的 this。</p><p>这是我们“JavaScript 执行机制”模块的最后一节了，五节下来，你应该已经发现我们将近一半的时间都是在谈 JavaScript 的各种缺陷，比如变量提升带来的问题、this 带来问题等。我认为了解一门语言的缺陷并不是为了否定它，相反是为了能更加深入地了解它。我们在谈论缺陷的过程中，还结合 JavaScript 的工作流程分析了出现这些缺陷的原因，以及避开这些缺陷的方法。掌握了这些，相信你今后在使用 JavaScript 的过程中会更加得心应手。</p><h2 id="思考时间" tabindex="-1"><a class="header-anchor" href="#思考时间" aria-hidden="true">#</a> 思考时间</h2><p>你可以观察下面这段代码：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> userInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&quot;jack.ma&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">,</span>
  <span class="token literal-property property">sex</span><span class="token operator">:</span>male<span class="token punctuation">,</span>
  <span class="token function-variable function">updateInfo</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//模拟xmlhttprequest请求延时</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;pony.ma&quot;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">39</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> female
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
userInfo<span class="token punctuation">.</span><span class="token function">updateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我想通过 updateInfo 来更新 userInfo 里面的数据信息，但是这段代码存在一些问题，你能修复这段代码吗？</p><p>欢迎在留言区与我分享你的想法，也欢迎你在留言区记录你的思考过程。感谢阅读，如果你觉得这篇文章对你有帮助的话，也欢迎把它分享给更多的朋友。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: kaiwei.zh@qq.com">Zhang Kaiwei</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/broswer-working-principle/assets/app.7d025128.js" defer></script>
  </body>
</html>
